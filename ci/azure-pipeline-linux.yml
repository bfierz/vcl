# Job template for Linux builds
# Required job variables:
# - buildConfig: 'Debug'
# - configCodeCoverage: 'off'
# - configVectorization: 'SSE 2'

steps:
- script: |
    # Install latest lcov
    if [ $CONFIGCODECOVERAGE == "on" ] ; then
      wget http://ftp.de.debian.org/debian/pool/main/l/lcov/lcov_1.13.orig.tar.gz
      tar xf lcov_1.13.orig.tar.gz
      sudo make -C lcov-1.13/ install
      # Update link to gcov
      sudo ln -sf /usr/bin/gcov-5 /usr/bin/gcov
      gcov --version
      # Install gcovr
      sudo pip install gcovr
      gcovr --version
    fi
    # Install lxml for python
    sudo pip install lxml
  displayName: 'Prepare Environment'

# https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/cmake
- task: CMake@1
  inputs:
    workingDirectory: 'build'
    cmakeArgs: -DCMAKE_BUILD_TYPE=$(buildConfig) -DVCL_CODE_COVERAGE:BOOL=$(configCodeCoverage) -DVCL_BUILD_BENCHMARKS:BOOL=off -DVCL_BUILD_TESTS:BOOL=on -DVCL_BUILD_TOOLS:BOOL=off -DVCL_BUILD_EXAMPLES:BOOL=off -DVCL_VECTORIZE:STRING="$(configVectorization)" ..

- script: |
    cmake --build build --config $(buildConfig) --target vcl.core.test
    cmake --build build --config $(buildConfig) --target vcl.components.test
    cmake --build build --config $(buildConfig) --target vcl.geometry.test
    cmake --build build --config $(buildConfig) --target vcl.math.test
  displayName: 'Build'
  continueOnError: false

- script: |
    cmake --build build --config $(buildConfig) --target vcl.test
    runTestSuccess=$?
    # Convert ctest output to junit-format
    # http://alexott.blogspot.com/2012/03/jenkins-cmakectest.html
    pushd build/tests
    if [ -f Testing/TAG ] ; then
      python ../../ci/ctest2junit.py . ../../ci/ctest2junit.xsl > JUnitResults.xml
      if [ ! -f JUnitResults.xml ]; then
        echo '##vso[task.complete result=Failed;]FAILED'
        exit 1
      fi
    fi
    popd
    if [ $runTestSuccess -ne 0 ]; then
      echo '##vso[task.complete result=SucceededWithIssues;]DONE'
    else
      # https://github.com/Microsoft/azure-pipelines-tasks/blob/master/docs/authoring/commands.md
      echo '##vso[task.complete result=Succeeded;]DONE'
    fi
  displayName: 'Run Unit Tests'

# Publish unit test results
# https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/test/publish-test-results
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit' # Options: JUnit, NUnit, VSTest, xUnit
    testResultsFiles: 'build/tests/**/JUnitResults.xml'
    #searchFolder: '$(System.DefaultWorkingDirectory)' # Optional
    mergeTestResults: true # Optional
    #testRunTitle: # Optional
    #buildPlatform: # Optional
    #buildConfiguration: # Optional
    #publishRunAttachments: true # Optional
  displayName: 'Publish Test Results'
  condition: succeeded()

# Publish Code Coverage Results
# https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/test/publish-code-coverage-results
- task: PublishCodeCoverageResults@1
  inputs:
    codeCoverageTool: 'Cobertura'
    summaryFileLocation: '**/vcl.test.xml'
    #reportDirectory: # Optional
    #additionalCodeCoverageFiles: # Optional
    failIfCoverageEmpty: true
  displayName: 'Publish Code Coverage Report'
  condition: and(succeeded(), eq(variables['configCodeCoverage'], 'on'))
